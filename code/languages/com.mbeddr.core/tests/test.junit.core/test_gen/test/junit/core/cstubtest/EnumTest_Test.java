package test.junit.core.cstubtest;

/*Generated by MPS */

import jetbrains.mps.baseLanguage.util.plugin.run.MPSLaunch;
import jetbrains.mps.lang.test.runtime.BaseTransformationTest;
import org.junit.Test;
import jetbrains.mps.lang.test.runtime.BaseTestBody;
import com.intellij.openapi.application.PathMacros;
import jetbrains.mps.smodel.SNode;
import junit.framework.Assert;
import test.junit.core.cstubtest_helper.CheckModuleContentHelper;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;
import org.eclipse.cdt.core.parser.ScannerInfo;
import org.eclipse.cdt.core.dom.ast.IASTTranslationUnit;
import org.eclipse.cdt.core.dom.ast.gnu.c.GCCLanguage;
import org.eclipse.cdt.core.parser.FileContent;
import org.eclipse.cdt.core.parser.IncludeFileContentProvider;
import org.eclipse.cdt.core.model.ILanguage;
import org.eclipse.cdt.core.parser.DefaultLogService;
import com.mbeddr.core.modules.runtime.include.CHeaderParser;
import org.eclipse.core.runtime.CoreException;

@MPSLaunch
public class EnumTest_Test extends BaseTransformationTest {
  @Test
  public void test_testEnumParser() throws Throwable {
    this.initTest("${mbeddr.github.core.home}/code/languages/com.mbeddr.core/core.dev.mpr", "r:ebbcbc09-f404-4ab3-b0c3-f9ae71bbe3f7(test.junit.core.cstubtest@tests)");
    this.runTest("test.junit.core.cstubtest.EnumTest_Test$TestBody", "test_testEnumParser", true);
  }

  @MPSLaunch
  public static class TestBody extends BaseTestBody {
    public void test_testEnumParser() throws Exception {
      String pathToEnum = PathMacros.getInstance().getValue("mbeddr.github.core.home") + "/code/languages/com.mbeddr.core/tests/test.ex.core.cStubTestInclude/include";
      pathToEnum += "/enumTestHeader.h";

      SNode externalModule = this.parseHeader(pathToEnum);
      Assert.assertNotNull(externalModule);
      Assert.assertNotNull(CheckModuleContentHelper.checkContentExists("simpleMonths", externalModule));
      Assert.assertNotNull(CheckModuleContentHelper.checkContentExists("refSimpleMonths", externalModule));
      Assert.assertNotNull(CheckModuleContentHelper.checkContentExists("just3Month", externalModule));
      Assert.assertNotNull(CheckModuleContentHelper.checkContentExists("typeSimpleMonth", externalModule));
      Assert.assertNotNull(CheckModuleContentHelper.checkContentExists("monthsWithValues", externalModule));
      Assert.assertNotNull(CheckModuleContentHelper.checkContentExists("monthValue", externalModule));

      // 
      SNode enumDeclSimpleMonth = CheckModuleContentHelper.checkContentExists("simpleMonths", externalModule);
      Assert.assertTrue(SNodeOperations.isInstanceOf(enumDeclSimpleMonth, "com.mbeddr.core.udt.structure.EnumDeclaration"));
      Assert.assertNotNull(CheckModuleContentHelper.checkChildExistsInNode("Apr", enumDeclSimpleMonth));
      Assert.assertNotNull(CheckModuleContentHelper.checkChildExistsInNode("May", enumDeclSimpleMonth));
      Assert.assertNotNull(CheckModuleContentHelper.checkChildExistsInNode("Jun", enumDeclSimpleMonth));

      SNode refSimpleMonth = CheckModuleContentHelper.checkContentExists("refSimpleMonths", externalModule);
      Assert.assertTrue(SNodeOperations.isInstanceOf(refSimpleMonth, "com.mbeddr.core.modules.structure.GlobalVariableDeclaration"));
      Assert.assertTrue(SNodeOperations.isInstanceOf(SLinkOperations.getTarget(((SNode) refSimpleMonth), "type", true), "com.mbeddr.core.udt.structure.EnumType"));
      SNode enumType = (SNode) (SLinkOperations.getTarget(((SNode) refSimpleMonth), "type", true));
      Assert.assertTrue(SLinkOperations.getTarget(enumType, "enum", false).equals(enumDeclSimpleMonth));

      SNode enumDeclmonthsWithValues = CheckModuleContentHelper.checkContentExists("monthsWithValues", externalModule);
      Assert.assertTrue(SNodeOperations.isInstanceOf(enumDeclmonthsWithValues, "com.mbeddr.core.udt.structure.EnumDeclaration"));
      Assert.assertNotNull(CheckModuleContentHelper.checkChildExistsInNode("Aug", enumDeclmonthsWithValues));
      Assert.assertNotNull(CheckModuleContentHelper.checkChildExistsInNode("Sep", enumDeclmonthsWithValues));
      Assert.assertNotNull(CheckModuleContentHelper.checkChildExistsInNode("Oct", enumDeclmonthsWithValues));
      Assert.assertNotNull(CheckModuleContentHelper.checkChildExistsInNode("Nov", enumDeclmonthsWithValues));
      Assert.assertNotNull(CheckModuleContentHelper.checkChildExistsInNode("Dec", enumDeclmonthsWithValues));

    }

    public SNode parseHeader(String path) {
      SNode module = SConceptOperations.createNewNode("com.mbeddr.core.modules.structure.ExternalModule", null);
      ScannerInfo info = new ScannerInfo();

      try {
        IASTTranslationUnit tu = GCCLanguage.getDefault().getASTTranslationUnit(FileContent.createForExternalFileLocation(path), info, IncludeFileContentProvider.getEmptyFilesProvider(), null, ILanguage.OPTION_IS_SOURCE_UNIT | ILanguage.OPTION_SKIP_FUNCTION_BODIES, new DefaultLogService());
        tu.accept(new CHeaderParser(module));

      } catch (CoreException ex) {
        Assert.fail("no exception expected");
      }
      return module;
    }
  }
}
